version: '3'

vars:
  VERSION:
    sh: git describe --tags|sed -e "s/\-/\./g"
  BUILD:
    sh: date +%FT%T%z
  COMMIT:
    sh: git rev-parse HEAD
  TARGETDIR:
    sh: echo $GOPATH/bin
  BIN: 'godepvis'
  PROJECT_PROTO_INCLUDE:
    sh: cd .. && pwd
  PROJECT_PROTO_OUT:
    sh: cd ../../../ && pwd
  VERSION_FLAGS: '-X main.Version={{.VERSION}} -X main.Build={{.BUILD}} -X main.Commit={{.COMMIT}}'

tasks:
  clean:
    cmds:
      - rm -f {{.TARGETDIR}}/{{.BIN}}

  release:
    cmds:
      - go build {{.LDFLAGS}} -o {{.TARGETDIR}}/{{.BIN}} ./cmd/{{.BIN}}
    vars:
      LDFLAGS: -ldflags "-s -w {{.VERSION_FLAGS}}"

  debug:
    cmds:
      - go build {{.LDFLAGS}} -o {{.TARGETDIR}}/{{.BIN}} ./cmd/{{.BIN}}
    vars:
      LDFLAGS: -ldflags "{{.VERSION_FLAGS}}"

  generate-examples:
    cmds:
      - ./scripts/generate-examples.sh

  lint:
    cmds:
      - golangci-lint run ./...

  test:
    cmds:
      - go test ./...
